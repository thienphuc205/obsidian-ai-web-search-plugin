/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var E=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var q=(x,m)=>{for(var e in m)E(x,e,{get:m[e],enumerable:!0})},$=(x,m,e,t)=>{if(m&&typeof m=="object"||typeof m=="function")for(let s of D(m))!R.call(x,s)&&s!==e&&E(x,s,{get:()=>m[s],enumerable:!(t=I(m,s))||t.enumerable});return x};var N=x=>$(E({},"__esModule",{value:!0}),x);var L={};q(L,{CHAT_VIEW_TYPE:()=>w,GeminiChatView:()=>k,default:()=>T});module.exports=N(L);var l=require("obsidian"),S={provider:"gemini",geminiApiKey:"",perplexityApiKey:"",tavilyApiKey:"",exaApiKey:"",geminiModel:"gemini-2.5-flash",perplexityModel:"sonar-pro",insertMode:"replace",maxResults:5,includeImages:!1,chatFolderName:"AI Web Search Chats",chatNoteTemplate:"timestamp-query",chatSaveEnabled:!0,quick:{geminiTemperature:.5,geminiTopP:.7,geminiTopK:20,geminiMaxTokens:1e3},comprehensive:{geminiTemperature:.7,geminiTopP:.8,geminiTopK:40,geminiMaxTokens:2e3},deep:{geminiTemperature:.8,geminiTopP:.9,geminiTopK:60,geminiMaxTokens:4e3},reasoning:{geminiTemperature:.3,geminiTopP:.6,geminiTopK:20,geminiMaxTokens:3e3},quickPerplexity:{temperature:.4,max_tokens:800,top_p:.7,top_k:20,frequency_penalty:0,presence_penalty:0,search_domain_filter:[],search_recency_filter:"day",return_related_questions:!1,return_citations:!0,return_images:!1,search_context_size:3},comprehensivePerplexity:{temperature:.6,max_tokens:2e3,top_p:.8,top_k:40,frequency_penalty:.1,presence_penalty:.1,search_domain_filter:[],search_recency_filter:"week",return_related_questions:!0,return_citations:!0,return_images:!0,search_context_size:8},deepPerplexity:{temperature:.7,max_tokens:4e3,top_p:.9,top_k:60,frequency_penalty:.2,presence_penalty:.2,search_domain_filter:[],search_recency_filter:"month",return_related_questions:!0,return_citations:!0,return_images:!0,search_context_size:12},reasoningPerplexity:{temperature:.2,max_tokens:3e3,top_p:.6,top_k:20,frequency_penalty:0,presence_penalty:0,search_domain_filter:[],search_recency_filter:"month",return_related_questions:!1,return_citations:!0,return_images:!1,search_context_size:10},exaSearchType:"auto",exaCategory:"",exaIncludeDomains:[],exaExcludeDomains:[],exaStartDate:"",exaEndDate:"",exaIncludeText:[],exaExcludeText:[],exaGetText:!0,exaGetHighlights:!0,exaGetSummary:!0,enableCustomPrompts:!1,quickPrompt:`### Task: Provide Quick and Accurate Response

You are a domain expert with extensive knowledge. Please answer the following question concisely and accurately:

**Question:** "{query}"

**Output Requirements:**
- Provide direct and concise answers (2-3 sentences maximum)
- Focus on the 2-3 most important points
- Use clear, easy-to-understand language
- If uncertain, state "Need more information to provide accurate answer"

**Format:** Direct answer without lengthy explanations.`,comprehensivePrompt:`### Framework: Comprehensive Analysis Using CRISPE

**Clarity:** You are a professional researcher with years of experience in the field.

**Relevance:** Conduct comprehensive analysis of the topic: "{query}"

**Iteration:** Structure your response in logical steps:

1. **Overview** (2-3 sentences introducing the topic)
2. **Key Aspects** (at least 3-4 important dimensions)
3. **Context and Applications** (why this matters)
4. **Concrete Examples** (1-2 illustrative cases)
5. **Conclusions and Future Directions**

**Specificity:** 
- Length: 400-600 words
- Language: Professional but accessible
- Citations: Mention sources when specific information is available

**Parameters:**
- Use bullet points and headings to organize information
- Avoid excessive technical jargon unless necessary
- Balance depth with accessibility

**Examples:** Include real-world examples to illustrate abstract concepts.`,deepPrompt:`### Framework: Deep Research Using TRACE

**Task:** Conduct in-depth research on: "{query}"

**Request (Specific Requirements):**
- Multi-dimensional analysis from at least 4-5 different perspectives
- Evaluate opposing viewpoints (if applicable)
- Connect to related fields and disciplines
- Length: 800-1200 words

**Action (Implementation Steps):**
1. **Foundation Analysis** - History, origins, definitions
2. **Current Landscape** - Present state, trends, developments
3. **Multiple Perspectives** - Views from different fields/schools of thought
4. **Deep Analysis** - Causes, effects, interconnections
5. **Future Implications** - Projected impacts, practical applications
6. **Critical Assessment** - Strengths, limitations, controversies

**Context:**
- You are a leading expert in this field
- Audience: Readers with good foundational knowledge
- Goal: Provide the most comprehensive and insightful perspective

**Example (Format Template):**
## I. Foundation Analysis
[Detailed content...]

## II. Professional Multi-Perspective View
### A. [Field 1] Perspective
### B. [Field 2] Perspective
[...]

## III. Conclusions and Implications
[Synthesis, projections...]

**Quality Note:** Only present information you have high confidence in. If lacking data in any section, acknowledge this and suggest directions for further research.`,reasoningPrompt:`### Framework: Advanced Logical Reasoning

**Meta-instruction:** You are a critical thinking expert with exceptional logical analysis capabilities.

**Analysis Task:** "{query}"

**Reasoning Process (Chain-of-Thought):**

### Step 1: Problem Decomposition
- Identify core components of the issue
- Categorize information: Facts | Assumptions | Unclear factors

### Step 2: Multi-Dimensional Analysis  
**A. Logical Analysis:**
- What premises are being assumed?
- What are the potential cause-effect relationships?

**B. Contextual Analysis:**
- What environmental/situational factors have influence?
- What are the constraints and boundary conditions?

**C. Perspective Analysis:**
- What are the viewpoints from different stakeholders?
- What potential biases exist in how the problem is framed?

### Step 3: Evidence Evaluation
- Categorize: Strong evidence | Weak evidence | Missing evidence
- Cross-validation: Are sources consistent?
- Reliability check: How reliable is each argument?

### Step 4: Synthetic Reasoning
**Primary Inference:**
[Present main logic chain with intermediate steps]

**Alternative Hypotheses:**
[Present and evaluate at least 2 alternative interpretations]

**Confidence Level of Conclusions:**
[Assess certainty level with reasoning]

### Step 5: Structured Conclusion
- **Main Conclusion:** [1-2 sentence summary]
- **Confidence Level:** [High/Medium/Low + rationale]  
- **Conditions:** [Under what circumstances is this conclusion valid]
- **Limitations:** [What hasn't been fully considered]
- **Future Research Directions:** [Open questions for the future]

**Final Check:** Question your own logic - are there any gaps or weaknesses?`},w="gemini-chat-view",k=class extends l.ItemView{constructor(e,t){super(e);this.currentVideoContext=null;this.plugin=t}getViewType(){return w}getDisplayText(){return"Gemini Chat"}getIcon(){return"message-circle"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("gemini-chat-container");let t=e.createEl("div",{cls:"gemini-chat-header"}),s=t.createEl("div",{cls:"title-container"});s.createEl("h3",{text:"AI Web Search Chat"});let i=s.createEl("button",{cls:"new-chat-button",title:"Start a new conversation (Ctrl/Cmd + N)",attr:{"aria-label":"Start new chat conversation",role:"button"}});i.innerHTML=`
			<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
				<line x1="12" y1="8" x2="12" y2="16"></line>
				<line x1="8" y1="12" x2="16" y2="12"></line>
			</svg>
			<span>New Chat</span>
		`,i.addEventListener("click",()=>{this.clearChat()}),this.containerEl.addEventListener("keydown",y=>{(y.ctrlKey||y.metaKey)&&y.key==="n"&&!y.shiftKey&&!y.altKey&&(y.preventDefault(),this.clearChat())});let n=t.createEl("div",{cls:"provider-container"});n.createEl("span",{text:"Provider: ",cls:"provider-label"});let a=n.createEl("select",{cls:"provider-dropdown"}),r=a.createEl("option",{value:"gemini",text:`Google Gemini ${this.checkApiKey("gemini")?"\u2713":"\u26A0\uFE0F"}`}),o=a.createEl("option",{value:"perplexity",text:`Perplexity AI ${this.checkApiKey("perplexity")?"\u2713":"\u26A0\uFE0F"}`}),c=a.createEl("option",{value:"tavily",text:`Tavily Search ${this.checkApiKey("tavily")?"\u2713":"\u26A0\uFE0F"}`}),d=a.createEl("option",{value:"exa",text:`Exa AI Search ${this.checkApiKey("exa")?"\u2713":"\u26A0\uFE0F"}`});a.value=this.plugin.settings.provider;let p=n.createEl("span",{cls:"model-container"});p.createEl("span",{text:"Model: ",cls:"model-label"});let g=p.createEl("select",{cls:"model-dropdown"});g.createEl("option",{value:"gemini-2.5-pro",text:"Gemini 2.5 Pro"}),g.createEl("option",{value:"gemini-2.5-flash",text:"Gemini 2.5 Flash"}),g.createEl("option",{value:"gemini-2.5-flash-lite",text:"Gemini 2.5 Flash Lite"}),g.value=this.plugin.settings.geminiModel,g.addEventListener("change",async y=>{let b=y.target.value;this.plugin.settings.geminiModel=b,await this.plugin.saveSettings()});let h=()=>{var P;let y=((P=this.currentResearchMode)==null?void 0:P.id)==="youtube",b=this.plugin.settings.provider==="gemini";p.style.display=y||b?"inline":"none"};h(),a.addEventListener("change",async y=>{var M;let b=y.target.value;if(((M=this.currentResearchMode)==null?void 0:M.id)==="youtube"&&b!=="gemini"){new l.Notice("\u{1F3AC} YouTube mode requires Gemini provider. Please switch to a different research mode first."),a.value="gemini";return}this.plugin.settings.provider=b,await this.plugin.saveSettings(),h(),this.checkApiKey(b)?this.addMessage("system",`Switched to ${b}. Ready for your questions!`):this.addMessage("system",`\u26A0\uFE0F Switched to ${b}, but API key not configured. Please add your API key in plugin settings.`)});let u=t.createEl("div",{cls:"video-context-container"});u.style.display="none";let v=u.createEl("div",{cls:"video-context-header"});v.createEl("span",{text:"\u{1F3AC} Video Context: ",cls:"video-context-label"});let f=v.createEl("span",{cls:"video-context-title",text:"No video loaded"});v.createEl("button",{cls:"clear-video-button",text:"\u274C",attr:{title:"Clear video context"}}).addEventListener("click",()=>{this.clearVideoContext()}),this.videoContextContainer=u,this.videoContextTitle=f,this.messageContainer=e.createEl("div",{cls:"gemini-chat-messages"}),this.inputContainer=e.createEl("div",{cls:"gemini-chat-input-container"}),this.createInputArea(),this.currentResearchMode={id:"comprehensive",label:"\u{1F50D} Comprehensive",description:"Balanced research with detailed analysis",model:"gemini-2.5-flash",perplexityModel:"sonar-pro",exaSearchType:"auto",exaCategory:""},this.checkApiKey(this.plugin.settings.provider)?this.addMessage("system",`Welcome! Ask me anything and I'll search the web for you using ${this.plugin.settings.provider}.`):this.addMessage("system",`\u26A0\uFE0F Welcome! Please configure your ${this.plugin.settings.provider} API key in plugin settings before starting.`)}setResearchMode(e){if(this.currentResearchMode=e,e.id==="youtube"){if(this.plugin.settings.provider!=="gemini"){this.plugin.settings.provider="gemini",this.plugin.saveSettings();let n=this.containerEl.querySelector(".provider-dropdown");n&&(n.value="gemini"),new l.Notice("\u{1F3AC} Switched to Gemini provider for YouTube video analysis")}this.plugin.settings.geminiModel="gemini-2.5-pro",this.plugin.saveSettings();let i=this.containerEl.querySelector(".model-dropdown");i&&(i.value="gemini-2.5-pro")}this.containerEl.querySelectorAll(".research-mode-btn-small").forEach(i=>{i.removeClass("active"),i.getAttribute("data-mode")===e.id&&i.addClass("active")});let s=this.containerEl.querySelector(".model-container");if(s){let i=e.id==="youtube",n=this.plugin.settings.provider==="gemini";s.style.display=i||n?"inline":"none"}this.plugin.settings.provider==="gemini"?this.plugin.settings.geminiModel=e.model:this.plugin.settings.provider==="perplexity"?this.plugin.settings.perplexityModel=e.perplexityModel:this.plugin.settings.provider==="exa"&&(this.plugin.settings.exaSearchType=e.exaSearchType,this.plugin.settings.exaCategory=e.exaCategory),this.plugin.saveSettings(),this.addMessage("system",`Research mode set to ${e.label}: ${e.description}`)}createInputArea(){var c;this.inputContainer.empty();let e=this.inputContainer.createEl("div",{cls:"input-group"}),t=e.createEl("textarea",{cls:"gemini-chat-input",attr:{placeholder:"Ask anything...",rows:"3"}}),s=e.createEl("div",{cls:"button-group"}),i=s.createEl("button",{cls:"send-button",text:"Send"}),n=s.createEl("button",{cls:"save-button",text:"Send & Save",attr:{title:"Send query and save chat to folder"}}),a=this.inputContainer.createEl("div",{cls:"research-mode-container-bottom"});a.createEl("div",{text:"Research Mode:",cls:"research-mode-label-small"});let r=a.createEl("div",{cls:"research-mode-buttons-bottom"});[{id:"quick",label:"\u26A1 Quick",description:"Fast answers",model:"gemini-2.5-flash-lite",perplexityModel:"sonar",exaSearchType:"fast",exaCategory:""},{id:"comprehensive",label:"\u{1F50D} Comprehensive",description:"Balanced research",model:"gemini-2.5-flash",perplexityModel:"sonar-pro",exaSearchType:"auto",exaCategory:""},{id:"deep",label:"\u{1F3AF} Deep",description:"Expert analysis",model:"gemini-2.5-pro",perplexityModel:"sonar-deep-research",exaSearchType:"neural",exaCategory:"research paper"},{id:"reasoning",label:"\u{1F9E0} Reasoning",description:"Complex analysis",model:"gemini-2.5-pro",perplexityModel:"sonar-reasoning",exaSearchType:"neural",exaCategory:"research paper"},{id:"youtube",label:"\u{1F3AC} YouTube",description:"Video analysis",model:"gemini-2.5-pro",perplexityModel:"sonar-pro",exaSearchType:"auto",exaCategory:"",providerLock:"gemini",requiresUrl:!0}].forEach(d=>{let p=r.createEl("button",{cls:`research-mode-btn-small research-mode-${d.id}`,attr:{"data-mode":d.id},text:d.label});p.addEventListener("click",()=>{this.setResearchMode(d),r.querySelectorAll(".research-mode-btn-small").forEach(h=>h.removeClass("active")),p.addClass("active")})}),(c=r.querySelector('[data-mode="comprehensive"]'))==null||c.addClass("active"),i.onclick=()=>this.handleSend(t.value,!1),n.onclick=()=>this.handleSend(t.value,!1,!0),t.addEventListener("keydown",d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),this.handleSend(t.value,!1))})}async handleSend(e,t,s=!1){var a;if(!e.trim())return;if(((a=this.currentResearchMode)==null?void 0:a.id)==="youtube"){let r=this.isValidYouTubeUrl(e.trim());if(!this.currentVideoContext&&!r){new l.Notice(`\u{1F3AC} YouTube Mode: Please paste a YouTube URL first to analyze a video

Supported formats:
\u2022 youtube.com/watch?v=VIDEO_ID
\u2022 youtu.be/VIDEO_ID`);return}if(r){let o=this.extractYouTubeVideoId(e.trim());o&&this.setVideoContext(e.trim(),o,"Video Analysis")}}let i=this.inputContainer.querySelector(".gemini-chat-input");i.value="",this.addMessage("user",e);let n=this.addMessage("assistant","Searching the web...",!0);try{let r=await this.plugin.performWebSearch(e);this.updateMessage(n,r),t&&this.insertToActiveNote(r),s&&this.plugin.settings.chatSaveEnabled&&await this.saveToFolder()}catch(r){this.updateMessage(n,`Error: ${r instanceof Error?r.message:String(r)}`)}}async saveToFolder(){try{let e=this.plugin.settings.chatFolderName,t=this.app.vault;t.getAbstractFileByPath(e)||await t.createFolder(e);let i=new Date().toISOString().slice(0,19).replace(/[T:]/g,"-"),a=(this.getFirstUserMessage()||"chat").slice(0,50).replace(/[^\w\s-]/g,"").replace(/\s+/g,"-"),r;switch(this.plugin.settings.chatNoteTemplate){case"timestamp-query":r=`${i}-${a}`;break;case"query-timestamp":r=`${a}-${i}`;break;case"query-only":r=a;break;case"counter":r=`chat-${t.getMarkdownFiles().filter(h=>h.path.startsWith(e)&&h.basename.startsWith("chat-")).length+1}`;break;default:r=`${i}-${a}`}let o=`${r}.md`,c=1;for(;t.getAbstractFileByPath(`${e}/${o}`);)o=`${r}-${c}.md`,c++;let d=this.formatChatNote(),p=`${e}/${o}`;await t.create(p,d),new l.Notice(`Chat saved to: ${p}`)}catch(e){new l.Notice(`Failed to save chat: ${e instanceof Error?e.message:String(e)}`),console.error("Save to folder error:",e)}}isValidYouTubeUrl(e){return/^https?:\/\/(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})(?:\S+)?$/.test(e.trim())}extractYouTubeVideoId(e){let t=e.match(/(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return t?t[1]:null}formatChatNote(){let e=new Date().toLocaleString(),t=this.plugin.settings.provider,s=this.currentResearchMode,i=`# AI Web Search Chat

`;return i+=`**Date:** ${e}
`,i+=`**Provider:** ${t}
`,i+=`**Research Mode:** ${s}

`,i+=`---

`,this.messageContainer.querySelectorAll(".message").forEach(a=>{var c,d;let r=a.querySelector(".message-role"),o=a.querySelector(".message-content");if(r&&o){let p=(c=r.textContent)==null?void 0:c.trim(),g=((d=o.textContent)==null?void 0:d.trim())||"";p==="You"?i+=`## \u{1F64B} You

${g}

`:p==="AI Assistant"&&!g.includes("Searching the web...")&&(i+=`## \u{1F916} AI Assistant

${g}

`)}}),i+=`
---
*Generated by AI Web Search Plugin*`,i}getFirstUserMessage(){var t;let e=this.messageContainer.querySelectorAll(".message.user .message-content");return e.length>0&&((t=e[0].textContent)==null?void 0:t.trim())||""}clearVideoContext(){this.currentVideoContext=null,this.updateVideoContextUI()}setVideoContext(e,t,s){this.currentVideoContext={url:e,videoId:t,title:s,analyzed:!0},this.updateVideoContextUI()}updateVideoContextUI(){var e;!this.videoContextContainer||!this.videoContextTitle||(this.currentVideoContext&&((e=this.currentResearchMode)==null?void 0:e.id)==="youtube"?(this.videoContextContainer.style.display="block",this.videoContextTitle.textContent=this.currentVideoContext.title||`Video ${this.currentVideoContext.videoId}`):this.videoContextContainer.style.display="none")}getVideoContext(){return this.currentVideoContext}addMessage(e,t,s=!1){let i=Date.now().toString(),n=this.messageContainer.createEl("div",{cls:`message ${e}`,attr:{"data-id":i}});if(e==="user")n.createEl("div",{cls:"message-role",text:"You"});else if(e==="assistant"){let r=n.createEl("div",{cls:"message-role-header"});r.createEl("span",{cls:"message-role",text:"AI Assistant"});let o=r.createEl("button",{cls:"copy-button",text:"\u{1F4CB} Copy"});o.addEventListener("click",()=>{navigator.clipboard.writeText(t),o.textContent="\u2705 Copied!",setTimeout(()=>{o.textContent="\u{1F4CB} Copy"},2e3)})}let a=n.createEl("div",{cls:"message-content"});return s&&a.addClass("thinking"),a.addClass("selectable-text"),e==="assistant"&&!s?this.renderMarkdownContent(a,t):a.textContent=t,this.messageContainer.scrollTop=this.messageContainer.scrollHeight,i}updateMessage(e,t){let s=this.messageContainer.querySelector(`[data-id="${e}"]`);if(s){let i=s.querySelector(".message-content");if(i){i.removeClass("thinking"),i.addClass("selectable-text"),this.renderMarkdownContent(i,t);let n=s.querySelector(".copy-button");n&&(n.onclick=()=>{navigator.clipboard.writeText(t),n.textContent="\u2705 Copied!",setTimeout(()=>{n.textContent="\u{1F4CB} Copy"},2e3)})}}}insertToActiveNote(e){let t=this.app.workspace.getActiveViewOfType(l.MarkdownView);if(t){let s=t.editor,i=s.getCursor();s.replaceRange(`

${e}
`,i),new l.Notice("Response inserted to note")}else new l.Notice("No active note to insert into")}clearChat(){if(!(this.messageContainer&&this.messageContainer.children.length>1&&!confirm("Are you sure you want to start a new chat? This will clear the current conversation.")))if(this.messageContainer)this.messageContainer.addClass("clearing"),setTimeout(()=>{this.messageContainer.empty(),this.messageContainer.removeClass("clearing"),this.currentResearchMode={id:"comprehensive",label:"\u{1F50D} Comprehensive",description:"Balanced research with detailed analysis",model:"gemini-2.5-flash",perplexityModel:"sonar-pro",exaSearchType:"auto",exaCategory:""},this.containerEl.querySelectorAll(".research-mode-btn-small").forEach(n=>{n.removeClass("active"),n.getAttribute("data-mode")==="comprehensive"&&n.addClass("active")});let i=this.checkApiKey(this.plugin.settings.provider)?`\u{1F195} New conversation started! Ask me anything and I'll search the web for you using ${this.plugin.settings.provider}.`:`\u26A0\uFE0F New conversation started! Please configure your ${this.plugin.settings.provider} API key in plugin settings before starting.`;this.addMessage("system",i),setTimeout(()=>{let n=this.containerEl.querySelector(".gemini-chat-input");n&&(n.focus(),n.placeholder="Ask anything to start your new conversation...",setTimeout(()=>{n.placeholder="Ask anything..."},3e3))},100)},200);else{let t=this.containerEl.querySelector(".gemini-chat-input");t&&t.focus()}}checkApiKey(e){switch(e){case"gemini":return!!this.plugin.settings.geminiApiKey;case"perplexity":return!!this.plugin.settings.perplexityApiKey;case"tavily":return!!this.plugin.settings.tavilyApiKey;case"exa":return!!this.plugin.settings.exaApiKey;default:return!1}}renderMarkdownContent(e,t){e.empty();let s=t.split(`
`),i=e,n=!1,a=[];s.forEach(r=>{if(r.startsWith("```"))if(n){let c=e.createEl("pre").createEl("code");c.textContent=a.join(`
`),a=[],n=!1,i=e}else n=!0;else if(n)a.push(r);else if(r.startsWith("### ")){let o=e.createEl("h3");o.textContent=r.replace("### ",""),i=e}else if(r.startsWith("## ")){let o=e.createEl("h2");o.textContent=r.replace("## ",""),i=e}else if(r.startsWith("# ")){let o=e.createEl("h1");o.textContent=r.replace("# ",""),i=e}else if(r.startsWith("- ")||r.startsWith("* ")){i.tagName!=="UL"&&(i=e.createEl("ul"));let o=i.createEl("li");this.parseInlineMarkdown(o,r.replace(/^[*-] /,""))}else if(r.startsWith("**Sources:**")||r.startsWith("--- ")){if(r.startsWith("--- "))e.createEl("hr");else{let o=e.createEl("h4");o.textContent="Sources:"}i=e}else if(r.trim()==="")e.createEl("br"),i=e;else{i.tagName==="UL"&&(i=e);let o=e.createEl("p");this.parseInlineMarkdown(o,r)}})}parseInlineMarkdown(e,t){let s=t;s=s.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),s=s.replace(/\*(.*?)\*/g,"<em>$1</em>"),s=s.replace(/`(.*?)`/g,"<code>$1</code>"),s=s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="external-link">$1 \u{1F517}</a>'),s=s.replace(/(https?:\/\/[^\s<>"{}|\\^`[\]]+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer" class="external-link">$1 \u{1F517}</a>'),s=s.replace(/\[(\d+)\]/g,`<a href="#citation-$1" class="citation-link" onclick="this.closest('.message-content').querySelector('h4:contains(Sources), strong:contains(Sources)')?.scrollIntoView({behavior: 'smooth', block: 'center'})">[$1]</a>`),e.innerHTML=s,e.querySelectorAll(".citation-link").forEach(n=>{n.addEventListener("click",a=>{a.preventDefault();let r=e.closest(".message-content");if(r){let o=Array.from(r.querySelectorAll("strong, h4")).find(c=>{var d;return(d=c.textContent)==null?void 0:d.includes("Sources")});o&&(o.scrollIntoView({behavior:"smooth",block:"center"}),o.style.backgroundColor="var(--interactive-accent)",o.style.color="white",o.style.padding="8px",o.style.borderRadius="4px",o.style.transition="all 0.3s ease",setTimeout(()=>{o.style.backgroundColor="",o.style.color="",o.style.padding=""},2e3))}})})}async onClose(){}},T=class extends l.Plugin{async onload(){await this.loadSettings(),this.injectEnhancedCSS(),this.registerView(w,e=>new k(e,this)),this.addRibbonIcon("message-circle","Open AI Web Search Chat",()=>{this.activateView()}),this.addCommand({id:"gemini-web-search-selection",name:"AI Web Search: Research with selected text",editorCallback:(e,t)=>{let s=e.getSelection();s?this.performWebSearchAndInsert(s,e):new l.Notice("Please select some text to search.")}}),this.addCommand({id:"gemini-web-search-prompt",name:"AI Web Search: Custom query",editorCallback:(e,t)=>{this.promptForCustomSearch(e)}}),this.addCommand({id:"gemini-open-chat",name:"AI Web Search: Open Chat Panel",callback:()=>{this.activateView()}}),this.addCommand({id:"gemini-new-chat",name:"AI Web Search: Start New Chat",callback:()=>{this.activateView().then(()=>{var t;let e=(t=this.app.workspace.getLeavesOfType(w)[0])==null?void 0:t.view;e&&e.clearChat()})}}),this.addCommand({id:"test-perplexity-api",name:"AI Web Search: Test Perplexity API",callback:async()=>{await this.testPerplexityAPI()}}),this.addSettingTab(new A(this.app,this))}injectEnhancedCSS(){let e=`
/* Enhanced Settings CSS for AI Web Search Plugin */
.gemini-settings-container {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
    line-height: 1.6;
}

.settings-title-section {
    text-align: center;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    color: white;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
}

.settings-title-section h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2rem;
    font-weight: 700;
}

.settings-subtitle {
    margin: 0;
    opacity: 0.9;
    font-size: 1.1rem;
}

.setting-section {
    margin-bottom: 1.5rem;
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.setting-section-header {
    padding: 1rem 1.5rem;
    background: var(--background-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 1px solid transparent;
    display: flex;
    align-items: center;
}

.setting-section-header:hover {
    background: var(--background-modifier-hover);
}

.setting-section-header.expanded {
    border-bottom-color: var(--background-modifier-border);
}

.setting-section-toggle {
    margin-right: 0.75rem;
    font-weight: bold;
    transition: transform 0.2s ease;
    font-size: 1.2rem;
}

.setting-section-title {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
}

.setting-section-description {
    margin: 0.5rem 0 0 2rem;
    opacity: 0.8;
    font-size: 0.9rem;
}

.setting-section-content {
    padding: 0;
    max-height: 0;
    overflow: hidden;
    transition: all 0.3s ease;
}

.setting-section-content.expanded {
    padding: 1.5rem;
    max-height: 3000px;
}

.provider-info-card {
    background: var(--background-secondary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1rem;
}

.provider-info-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.provider-info-header h4 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
}

.provider-description {
    margin: 0 0 1rem 0;
    font-style: italic;
    color: var(--text-muted);
}

.provider-features {
    margin: 0 0 1rem 0;
    padding-left: 1.5rem;
}

.provider-features li {
    margin-bottom: 0.25rem;
}

.provider-specs {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.spec-item {
    background: var(--background-modifier-form-field);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.status-indicator {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-indicator.connected {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-indicator.disconnected {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.setting-help-text, .settings-help-text {
    background: var(--background-secondary);
    border-left: 4px solid var(--interactive-accent);
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 0 6px 6px 0;
    font-size: 0.9rem;
    line-height: 1.5;
}

.setting-help-text ul, .settings-help-text ul {
    margin: 0.5rem 0 0 0;
    padding-left: 1.5rem;
}

.setting-help-text li, .settings-help-text li {
    margin-bottom: 0.5rem;
}

.setting-help-text strong, .settings-help-text strong {
    color: var(--interactive-accent);
}

.provider-tabs {
    display: flex;
    background: var(--background-secondary);
    border-radius: 8px 8px 0 0;
    overflow: hidden;
}

.provider-tab {
    flex: 1;
    padding: 1rem;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
}

.provider-tab:hover {
    background: var(--background-modifier-hover);
    color: var(--text-normal);
}

.provider-tab.active {
    background: var(--interactive-accent);
    color: white;
}

.provider-tabs-content {
    border: 1px solid var(--background-modifier-border);
    border-top: none;
    border-radius: 0 0 8px 8px;
}

.provider-tab-content {
    display: none;
    padding: 1.5rem;
}

.provider-tab-content.active {
    display: block;
}

.presets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.exa-presets {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 2px solid var(--background-modifier-border);
}
		`,t=document.createElement("style");t.textContent=e,document.head.appendChild(t)}async activateView(){let{workspace:e}=this.app,t=null,s=e.getLeavesOfType(w);s.length>0?t=s[0]:(t=e.getRightLeaf(!1),await(t==null?void 0:t.setViewState({type:w,active:!0}))),t&&e.revealLeaf(t)}async performWebSearch(e){switch(this.settings.provider){case"gemini":return this.searchWithGemini(e);case"perplexity":return this.searchWithPerplexity(e);case"tavily":return this.searchWithTavily(e);case"exa":return this.searchWithExa(e);default:throw new Error("Invalid provider")}}async searchWithGemini(e){var g,h,u;if(!this.settings.geminiApiKey)throw new Error("Gemini API key not configured");let t=(g=this.app.workspace.getLeavesOfType(w)[0])==null?void 0:g.view,s=t==null?void 0:t.currentResearchMode,i=this.settings.comprehensive;if(s)switch(s.id){case"quick":i=this.settings.quick;break;case"comprehensive":i=this.settings.comprehensive;break;case"deep":i=this.settings.deep;break;case"reasoning":i=this.settings.reasoning;break;case"youtube":i=this.settings.comprehensive;break}let n=e;if(this.settings.enableCustomPrompts&&s)switch(s.id){case"quick":n=this.settings.quickPrompt.replace("{query}",e);break;case"comprehensive":n=this.settings.comprehensivePrompt.replace("{query}",e);break;case"deep":n=this.settings.deepPrompt.replace("{query}",e);break;case"reasoning":n=this.settings.reasoningPrompt.replace("{query}",e);break;case"youtube":n=`Analyze this YouTube video and provide a comprehensive summary and insights: ${e}`;break;default:n=this.settings.comprehensivePrompt.replace("{query}",e)}else if(s)switch(s.id){case"quick":n=`### Task: Provide Quick and Accurate Response

You are a domain expert with extensive knowledge. Please answer the following question concisely and accurately:

**Question:** "${e}"

**Output Requirements:**
- Provide direct and concise answers (2-3 sentences maximum)
- Focus on the 2-3 most important points
- Use clear, easy-to-understand language
- If uncertain, state "Need more information to provide accurate answer"

**Format:** Direct answer without lengthy explanations.`;break;case"comprehensive":n=`### Framework: Comprehensive Analysis

**Task:** Comprehensive analysis of the topic: "${e}"

**Response Structure:**
1. **Overview** (2-3 introductory sentences)
2. **Key Aspects** (3-4 important dimensions)
3. **Context and Applications** (why this matters)
4. **Concrete Examples** (1-2 illustrative cases)
5. **Conclusions and Future Directions**

**Requirements:** 400-600 words, professional but accessible, cite sources when available.`;break;case"deep":n=`### Framework: Deep Research

**Task:** In-depth research on: "${e}"

**Analysis includes:**
1. **Foundation Analysis** - History, origins, definitions
2. **Current Landscape** - Present state, trends  
3. **Multiple Perspectives** - Views from different fields
4. **Deep Analysis** - Causes, effects, interconnections
5. **Future Implications** - Projected impacts, practical applications
6. **Critical Assessment** - Strengths, limitations, controversies

**Requirements:** 800-1200 words, comprehensive and insightful perspective, clear structure.`;break;case"reasoning":n=`### Framework: Logical Reasoning

**Analysis Task:** "${e}"

**Thinking Process:**
1. **Problem Decomposition** - Identify core components
2. **Multi-dimensional Analysis** - Logic, context, different perspectives
3. **Evidence Evaluation** - Categorize reliability levels
4. **Synthetic Reasoning** - Logic chain and alternative hypotheses
5. **Structured Conclusion** - Conclusion, confidence level, limitations

**Requirements:** Critical thinking, excellent logical analysis, self-check for logical gaps.`;break;case"youtube":n=`### Task: YouTube Video Analysis

**Video URL:** ${e}

**Analysis Framework:**
1. **Video Overview** - Title, creator, duration, upload date
2. **Content Summary** - Main topics and key points covered
3. **Detailed Analysis** - Important insights, data, arguments presented
4. **Context and Relevance** - Why this content matters, target audience
5. **Key Takeaways** - Most valuable information and actionable insights
6. **Critical Assessment** - Strengths, limitations, credibility

**Requirements:** 
- Comprehensive analysis of video content
- Focus on factual information and key insights
- Highlight important quotes or data points
- Assess credibility and educational value
- 600-800 words, well-structured and informative`;break;default:n=`Please provide comprehensive analysis on: "${e}" with accurate information and reliable sources.`}let a=`https://generativelanguage.googleapis.com/v1beta/models/${this.settings.geminiModel}:generateContent?key=${this.settings.geminiApiKey}`,r;if((s==null?void 0:s.id)==="youtube"&&(t!=null&&t.getVideoContext())){let v=t.getVideoContext();if(!v)return"Error: No video context available";let f=v.url;r={contents:[{parts:[{text:t.isValidYouTubeUrl(e)?n:`Based on the YouTube video at ${f}, please answer this question: "${e}"

**Context:** You are analyzing the video content to provide a specific answer.
**Requirements:** 
- Focus on answering the specific question asked
- Reference relevant parts of the video content
- Provide accurate and detailed information
- Include timestamps or specific examples when relevant`},{fileData:{mimeType:"video/*",fileUri:f}}]}],generationConfig:{temperature:i.geminiTemperature,topP:i.geminiTopP,topK:i.geminiTopK,maxOutputTokens:i.geminiMaxTokens}}}else r={contents:[{parts:[{text:n}]}],tools:[{google_search:{}}],generationConfig:{temperature:i.geminiTemperature,topP:i.geminiTopP,topK:i.geminiTopK,maxOutputTokens:i.geminiMaxTokens}};let d=(h=(await(0,l.requestUrl)({url:a,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).json.candidates)==null?void 0:h[0];if(!d)throw new Error("No response from Gemini");let p=d.content.parts[0].text;if((u=d.groundingMetadata)!=null&&u.groundingChunks){p+=`

--- 
**Sources:**
`;let v=new Set;d.groundingMetadata.groundingChunks.forEach(f=>{var C;(C=f.web)!=null&&C.uri&&v.add(`- [${f.web.title||f.web.uri}](${f.web.uri})`)}),p+=Array.from(v).join(`
`)}return p}async searchWithPerplexity(e){var r,o,c,d,p;if(!this.settings.perplexityApiKey)throw new Error("Perplexity API key not configured");let t=(r=this.app.workspace.getLeavesOfType(w)[0])==null?void 0:r.view,s=t==null?void 0:t.currentResearchMode,i;switch(s==null?void 0:s.id){case"quick":i="sonar";break;case"comprehensive":i="sonar-pro";break;case"deep":i="sonar-pro";break;case"reasoning":i="sonar-reasoning-pro";break;default:i="sonar"}let n=this.settings.comprehensivePerplexity;if(s)switch(s.id){case"quick":n=this.settings.quickPerplexity;break;case"comprehensive":n=this.settings.comprehensivePerplexity;break;case"deep":n=this.settings.deepPerplexity;break;case"reasoning":n=this.settings.reasoningPerplexity;break}let a={model:i,messages:[{role:"user",content:e}],return_citations:!0,return_related_questions:!0};n.max_tokens&&n.max_tokens!==2e3&&(a.max_tokens=n.max_tokens),n.temperature!==void 0&&n.temperature!==.6&&(a.temperature=n.temperature),n.top_p!==void 0&&n.top_p!==.9&&(a.top_p=n.top_p),n.return_citations&&(a.return_citations=!0),n.return_images&&(a.return_images=!0),n.return_related_questions&&(a.return_related_questions=!0),n.search_domain_filter&&n.search_domain_filter.length>0&&(a.search_domain_filter=n.search_domain_filter),n.search_recency_filter&&n.search_recency_filter!=="month"&&(a.search_recency_filter=n.search_recency_filter),console.log("\u{1F50D} Perplexity API Request:",JSON.stringify(a,null,2));try{let h=(await(0,l.requestUrl)({url:"https://api.perplexity.ai/chat/completions",method:"POST",headers:{Authorization:`Bearer ${this.settings.perplexityApiKey}`,"Content-Type":"application/json"},body:JSON.stringify(a)})).json;console.log("\u2705 Perplexity API Response:",h),console.log("\u{1F4CA} Response structure keys:",Object.keys(h)),(o=h.choices)!=null&&o[0]&&(console.log("\u{1F50D} Choice structure:",Object.keys(h.choices[0])),h.choices[0].message&&console.log("\u{1F4AC} Message structure:",Object.keys(h.choices[0].message)));let u=(p=(d=(c=h.choices)==null?void 0:c[0])==null?void 0:d.message)==null?void 0:p.content;if(!u)throw new Error("No response content from Perplexity API");return this.enhancePerplexityResponse(u,h)}catch(g){throw console.error("\u274C Perplexity API Error:",g),console.error("Status:",g.status),console.error("Response:",g.text),g.status===400?new Error(`Perplexity API 400 Error: ${g.text||"Invalid request format"}
Model: ${i}
Check console for request details.`):g.status===401?new Error("Perplexity API key is invalid or expired. Please check your API key."):g.status===403?new Error("Perplexity API access forbidden. Check your subscription status."):g.status===429?new Error("Perplexity API rate limit exceeded. Please wait and try again."):new Error(`Perplexity API Error (${g.status}): ${g.text||g.message}`)}}enhancePerplexityResponse(e,t){let s=e;console.log("\u{1F527} Processing Perplexity response for citations..."),console.log("\u{1F4DD} Original content length:",e.length),console.log("\u{1F50D} ResponseData keys:",Object.keys(t));let i=t.citations||[],n=t.related_questions||[];return console.log("\u{1F4DA} Citations from API:",i),console.log("\u2753 Related questions from API:",n),s=this.linkCitationsInContent(s,i),i&&i.length>0?(s+=`

---

## Sources

`,i.forEach((a,r)=>{let o=this.extractTitleFromUrl(a)||`Source ${r+1}`;s+=`${r+1}. [${o}](${a})
`})):(console.log("\u{1F50D} No citations in API response, extracting from content..."),s=this.extractAndFormatCitationsAdvanced(s)),n&&n.length>0&&(s+=`

## Related Questions

`,n.forEach(a=>{s+=`- ${a}
`})),console.log("\u2705 Enhanced content length:",s.length),s}linkCitationsInContent(e,t){return console.log("\u{1F517} Linking citations in content..."),console.log("\u{1F4CB} Available citations:",t),e}extractTitleFromUrl(e){try{let t=new URL(e),s=t.hostname.replace("www.",""),i=t.pathname.split("/").filter(n=>n&&n!=="");if(i.length>0){let n=i[i.length-1];n&&!n.includes(".")&&(s+=" - "+n.replace(/-/g," ").replace(/_/g," "))}return s.charAt(0).toUpperCase()+s.slice(1)}catch(t){return e}}extractAndFormatCitations(e){let t=/\[(\d+)\]/g,s=new Set,i;for(;(i=t.exec(e))!==null;)s.add(i[1]);return s.size>0&&!e.includes("**Sources:**")&&(e+=`

---
**Sources:**
`,Array.from(s).sort((n,a)=>parseInt(n)-parseInt(a)).forEach(n=>{e+=`- [Source ${n}](#citation-${n})
`}),e+=`
*Note: Source links depend on Perplexity's citation data availability*`),e}extractAndFormatCitationsAdvanced(e){console.log("\u{1F50D} Advanced citation extraction...");let t=/\[(\d+)\]/g,s=new Set,i;for(;(i=t.exec(e))!==null;)s.add(i[1]);console.log("\u{1F4CA} Found citation numbers:",Array.from(s));let n=e.includes("**Sources:**")||e.includes("Sources:");if(s.size>0&&!n){let a=e.split(`
`),r=[],o=!1;for(let c=a.length-1;c>=0;c--){let d=a[c].trim();if(d.match(/^\d+\.\s*https?:\/\//)||d.match(/^\[\d+\]\s*https?:\/\//)||d.match(/^https?:\/\/\S+/))r.unshift(d),o=!0;else if(o&&d.length>0)break}r.length>0?(console.log("\u{1F4DA} Found source lines:",r),e=a.slice(0,a.length-r.length).join(`
`).trim()+`

---
**Sources:**
`,r.forEach((d,p)=>{let g=d.match(/(https?:\/\/[^\s]+)/);if(g){let h=g[1],u=d.replace(g[0],"").replace(/^\d+\.\s*/,"").replace(/^\[\d+\]\s*/,"").trim()||`Source ${p+1}`;e+=`- [${u||h}](${h})
`}})):(e+=`

---
**Sources:**
`,Array.from(s).sort((c,d)=>parseInt(c)-parseInt(d)).forEach(c=>{e+=`- [Source ${c}](#citation-${c})
`}),e+=`
*Note: Source links depend on Perplexity's citation data availability*`)}return e}async testPerplexityAPI(){var t;console.log("\u{1F9EA} Testing Perplexity API..."),console.log("API Key exists:",!!this.settings.perplexityApiKey),console.log("API Key prefix:",((t=this.settings.perplexityApiKey)==null?void 0:t.substring(0,8))+"...");let e={model:"sonar",messages:[{role:"user",content:"Hello! Can you tell me what is the capital of France? This is just a test."}],max_tokens:100,temperature:.7};console.log("\u{1F4E4} Test Request Body:",JSON.stringify(e,null,2));try{let s=await(0,l.requestUrl)({url:"https://api.perplexity.ai/chat/completions",method:"POST",headers:{Authorization:`Bearer ${this.settings.perplexityApiKey}`,"Content-Type":"application/json"},body:JSON.stringify(e)});console.log("\u2705 Success! Response:",s.json),new l.Notice("\u2705 Perplexity API test successful! Check console for details.")}catch(s){console.error("\u274C Perplexity API test failed:",s),console.error("Status:",s.status),console.error("Response text:",s.text);let i=`\u274C Perplexity API test failed!

`;i+=`Status: ${s.status}
`,i+=`Error: ${s.text||s.message}

`,s.status===400?(i+=`Likely cause: Invalid request format or model name
`,i+="Check console for full request details."):s.status===401?(i+=`Likely cause: Invalid API key
`,i+='Make sure your API key starts with "pplx-"'):s.status===403&&(i+=`Likely cause: No access to this model
`,i+="Check your Perplexity subscription status"),new l.Notice(i,1e4)}}async searchWithTavily(e){var n;if(!this.settings.tavilyApiKey)throw new Error("Tavily API key not configured");let s=(await(0,l.requestUrl)({url:"https://api.tavily.com/search",method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.tavilyApiKey}`},body:JSON.stringify({query:e,search_depth:"advanced",include_answer:!0,include_raw_content:!1,max_results:this.settings.maxResults})})).json,i=s.answer||"No answer found";return((n=s.results)==null?void 0:n.length)>0&&(i+=`

--- 
**Sources:**
`,s.results.forEach(a=>{i+=`- [${a.title}](${a.url})
`})),i}async searchWithExa(e){var o;if(!this.settings.exaApiKey)throw new Error("Exa API key not configured");let t=(o=this.app.workspace.getLeavesOfType(w)[0])==null?void 0:o.view,s=t==null?void 0:t.currentResearchMode,i=this.settings.exaSearchType,n=this.settings.maxResults,a=this.settings.exaCategory;if(s)switch(s.id){case"quick":i="fast",n=Math.min(this.settings.maxResults,3);break;case"comprehensive":i="auto",n=this.settings.maxResults;break;case"deep":i="neural",n=Math.max(this.settings.maxResults,8),a=s.exaCategory||"research paper";break;case"reasoning":i="neural",n=this.settings.maxResults,a=s.exaCategory||"research paper";break}let r={query:e,type:i,numResults:Math.min(n,100),contents:{text:this.settings.exaGetText,highlights:this.settings.exaGetHighlights,summary:this.settings.exaGetSummary}};a&&(r.category=a),this.settings.exaIncludeDomains.length>0&&(r.includeDomains=this.settings.exaIncludeDomains),this.settings.exaExcludeDomains.length>0&&(r.excludeDomains=this.settings.exaExcludeDomains),this.settings.exaStartDate&&(r.startPublishedDate=this.settings.exaStartDate),this.settings.exaEndDate&&(r.endPublishedDate=this.settings.exaEndDate),this.settings.exaIncludeText.length>0&&(r.includeText=this.settings.exaIncludeText),this.settings.exaExcludeText.length>0&&(r.excludeText=this.settings.exaExcludeText);try{let d=(await(0,l.requestUrl)({url:"https://api.exa.ai/search",method:"POST",headers:{"x-api-key":this.settings.exaApiKey,"Content-Type":"application/json"},body:JSON.stringify(r)})).json;if(!d.results||d.results.length===0)return"No results found for your query.";let p=`# Search Results for: "${e}"

`;return p+=`*Search performed using **${d.resolvedSearchType||i}** search (${d.results.length} results)*

`,d.results.forEach((g,h)=>{if(p+=`## ${h+1}. ${g.title}

`,g.summary&&this.settings.exaGetSummary&&(p+=`**Summary:** ${g.summary}

`),g.text&&this.settings.exaGetText){let u=g.text.length>800?g.text.substring(0,800)+"...":g.text;p+=`${u}

`}if(g.highlights&&g.highlights.length>0&&this.settings.exaGetHighlights&&(p+=`**Key Highlights:**
`,g.highlights.forEach(u=>{p+=`- *${u}*
`}),p+=`
`),g.author&&(p+=`**Author:** ${g.author}
`),g.publishedDate){let u=new Date(g.publishedDate).toLocaleDateString();p+=`**Published:** ${u}
`}g.score&&(p+=`**Relevance Score:** ${(g.score*100).toFixed(1)}%
`),p+=`**Source:** [${g.url}](${g.url})

`,p+=`---

`}),p+=`## Sources

`,d.results.forEach((g,h)=>{p+=`${h+1}. [${g.title}](${g.url})`,g.author&&(p+=` - ${g.author}`),p+=`
`}),d.costDollars&&(p+=`
*Search cost: $${d.costDollars.total.toFixed(4)}*
`),p}catch(c){throw console.error("Exa search error:",c),new Error(`Exa search failed: ${c instanceof Error?c.message:String(c)}`)}}async performWebSearchAndInsert(e,t){try{let s=await this.performWebSearch(e);if(this.settings.insertMode==="replace")t.replaceSelection(s);else{let i=t.getCursor();t.replaceRange(`

${s}
`,i)}new l.Notice("Search complete!")}catch(s){new l.Notice(`Search failed: ${s instanceof Error?s.message:String(s)}`)}}async promptForCustomSearch(e){let t=prompt("Enter your search query:");t&&this.performWebSearchAndInsert(t,e)}async loadSettings(){this.settings=Object.assign({},S,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},A=class extends l.PluginSettingTab{constructor(e,t){super(e,t);this.collapsedSections=new Set;this.plugin=t}createCollapsibleSection(e,t,s,i,n=!1){let a=e.createEl("div",{cls:"setting-section"}),r=a.createEl("div",{cls:`setting-section-header ${n?"expanded":"collapsed"}`,attr:{"data-section":i}}),o=r.createEl("span",{cls:"setting-section-toggle",text:n?"\u25BC":"\u25B6"}),c=r.createEl("h3",{text:t,cls:"setting-section-title"});s&&r.createEl("p",{text:s,cls:"setting-section-description"});let d=a.createEl("div",{cls:`setting-section-content ${n?"expanded":"collapsed"}`});return r.addEventListener("click",()=>{!this.collapsedSections.has(i)?(this.collapsedSections.add(i),r.removeClass("expanded"),r.addClass("collapsed"),d.removeClass("expanded"),d.addClass("collapsed"),o.textContent="\u25B6"):(this.collapsedSections.delete(i),r.removeClass("collapsed"),r.addClass("expanded"),d.removeClass("collapsed"),d.addClass("expanded"),o.textContent="\u25BC")}),n||this.collapsedSections.add(i),{headerEl:r,contentEl:d}}createStatusIndicator(e,t){let s=document.createElement("span");return s.className=`status-indicator ${e?"connected":"disconnected"}`,s.textContent=e?"\u2713 Configured":"\u26A0\uFE0F Not configured",s.title=e?`${t} API key is configured and ready to use`:`${t} API key is missing. Add your API key to enable this provider.`,s}createResetButton(e,t,s,i){new l.Setting(e).setName(t).setDesc(s).addButton(n=>n.setButtonText("Reset to Defaults").setCta().onClick(async()=>{i(),await this.plugin.saveSettings(),this.display()}))}display(){let{containerEl:e}=this;e.empty(),e.addClass("gemini-settings-container");let t=e.createEl("div",{cls:"settings-title-section"});t.createEl("h1",{text:"\u{1F680} AI Web Search Settings"}),t.createEl("p",{text:"Comprehensive AI-powered web search with 4 providers: Gemini, Perplexity, Tavily, and Exa",cls:"settings-subtitle"});let{contentEl:s}=this.createCollapsibleSection(e,"\u26A1 Quick Setup","Essential settings to get started quickly","quick-setup",!0),n=new l.Setting(s).setName("\u{1F3AF} Search Provider").setDesc("Choose which AI service to use for web search").settingEl.createEl("div",{cls:"provider-selection-container"}),a=n.createEl("select",{cls:"provider-dropdown-enhanced"});[{value:"gemini",label:"Google Gemini",description:"Direct Google Search integration, real-time grounding",hasKey:!!this.plugin.settings.geminiApiKey},{value:"perplexity",label:"Perplexity AI",description:"Real-time web search with citations and analysis",hasKey:!!this.plugin.settings.perplexityApiKey},{value:"tavily",label:"Tavily Search",description:"Advanced web search API optimized for AI applications",hasKey:!!this.plugin.settings.tavilyApiKey},{value:"exa",label:"Exa (Neural Search)",description:"Semantic neural search, 425ms latency, AI-optimized",hasKey:!!this.plugin.settings.exaApiKey}].forEach(d=>{let p=a.createEl("option",{value:d.value,text:`${d.label} ${d.hasKey?"\u2713":"\u26A0\uFE0F"}`})}),a.value=this.plugin.settings.provider;let o=n.createEl("div",{cls:"provider-info"});this.updateProviderInfo(o,this.plugin.settings.provider),a.addEventListener("change",async d=>{let p=d.target.value;this.plugin.settings.provider=p,await this.plugin.saveSettings(),this.updateProviderInfo(o,p),this.display()}),new l.Setting(s).setName("\u{1F4DD} Insert Mode").setDesc("How to insert AI responses when using text selection commands in notes").addDropdown(d=>d.addOption("replace","\u{1F504} Replace - Replace selected text with AI response").addOption("append","\u2795 Append - Insert AI response at cursor position").setValue(this.plugin.settings.insertMode).onChange(async p=>{this.plugin.settings.insertMode=p,await this.plugin.saveSettings()})),new l.Setting(s).setName("\u{1F522} Max Search Results").setDesc("Number of web sources to analyze (more = comprehensive but slower)").addSlider(d=>d.setLimits(1,20,1).setValue(this.plugin.settings.maxResults).setDynamicTooltip().onChange(async p=>{this.plugin.settings.maxResults=p,await this.plugin.saveSettings();let g=p<=5?"Quick searches (1-2 seconds)":p<=10?"Balanced speed/depth (2-4 seconds)":"Deep research (4-8 seconds)";d.sliderEl.title=g})),new l.Setting(s).setName("\u{1F3A8} Enable Custom Research Prompts").setDesc("Use custom prompts for research modes instead of built-in defaults").addToggle(d=>d.setValue(this.plugin.settings.enableCustomPrompts).onChange(async p=>{this.plugin.settings.enableCustomPrompts=p,await this.plugin.saveSettings(),this.display()}));let{contentEl:c}=this.createCollapsibleSection(e,"\u{1F511} API Keys Configuration","Manage API keys for all providers (only current provider key is required)","api-keys",!1);this.addAllApiKeys(c),this.addProviderSpecificSettings(e),this.plugin.settings.enableCustomPrompts&&this.addCustomPromptSettings(e),this.addAdvancedProviderSettings(e),this.addChatSavingSettings(e),this.addPresetConfigurations(e)}addGeminiSettings(e){new l.Setting(e).setName("Gemini API Key").setDesc("Get your API key from Google AI Studio").addText(t=>t.setPlaceholder("Enter your Gemini API key").setValue(this.plugin.settings.geminiApiKey).onChange(async s=>{this.plugin.settings.geminiApiKey=s,await this.plugin.saveSettings()})),new l.Setting(e).setName("Gemini Model").setDesc("Choose Gemini model to use").addDropdown(t=>t.addOption("gemini-2.5-flash-lite","Gemini 2.5 Flash Lite (Fastest)").addOption("gemini-2.5-flash","Gemini 2.5 Flash (Fast)").addOption("gemini-2.5-pro","Gemini 2.5 Pro (Advanced)").addOption("gemini-1.5-flash","Gemini 1.5 Flash (Legacy)").setValue(this.plugin.settings.geminiModel).onChange(async s=>{this.plugin.settings.geminiModel=s,await this.plugin.saveSettings()})),e.createEl("h4",{text:"Research-Mode-Specific Gemini Parameters"}),e.createEl("p",{text:"Each research mode has its own optimized parameter settings:",cls:"setting-item-description"}),this.addResearchModeGeminiSettings(e,"quick","\u26A1 Quick Mode","Fast, focused responses"),this.addResearchModeGeminiSettings(e,"comprehensive","\u{1F50D} Comprehensive Mode","Balanced analysis"),this.addResearchModeGeminiSettings(e,"deep","\u{1F52C} Deep Mode","Thorough research"),this.addResearchModeGeminiSettings(e,"reasoning","\u{1F9E0} Reasoning Mode","Logical analysis")}addResearchModeGeminiSettings(e,t,s,i){let n=e.createEl("div",{cls:"research-mode-settings"});n.createEl("h5",{text:s,cls:"research-mode-title"}),n.createEl("p",{text:i,cls:"research-mode-description"});let a=t,r=this.plugin.settings[a];new l.Setting(n).setName("Temperature").setDesc("Controls randomness (0.0 = deterministic, 1.0 = very random)").addSlider(o=>o.setLimits(0,1,.1).setValue(r.geminiTemperature).setDynamicTooltip().onChange(async c=>{this.plugin.settings[a].geminiTemperature=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Top P").setDesc("Nucleus sampling threshold (0.1 = conservative, 1.0 = diverse)").addSlider(o=>o.setLimits(.1,1,.1).setValue(r.geminiTopP).setDynamicTooltip().onChange(async c=>{this.plugin.settings[a].geminiTopP=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Top K").setDesc("Number of top tokens to consider (1-100)").addSlider(o=>o.setLimits(1,100,1).setValue(r.geminiTopK).setDynamicTooltip().onChange(async c=>{this.plugin.settings[a].geminiTopK=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Max Output Tokens").setDesc("Maximum response length (100-8192)").addSlider(o=>o.setLimits(100,8192,100).setValue(r.geminiMaxTokens).setDynamicTooltip().onChange(async c=>{this.plugin.settings[a].geminiMaxTokens=c,await this.plugin.saveSettings()}))}addPerplexitySettings(e){new l.Setting(e).setName("Perplexity API Key").setDesc("Get your API key from Perplexity.ai").addText(t=>t.setPlaceholder("Enter your Perplexity API key").setValue(this.plugin.settings.perplexityApiKey).onChange(async s=>{this.plugin.settings.perplexityApiKey=s,await this.plugin.saveSettings()})),new l.Setting(e).setName("Perplexity Model").setDesc("Choose Perplexity model to use").addDropdown(t=>t.addOption("sonar","Sonar (Basic search)").addOption("sonar-pro","Sonar Pro (Advanced search)").addOption("sonar-reasoning","Sonar Reasoning (Complex analysis)").addOption("sonar-deep-research","Sonar Deep Research (Comprehensive)").setValue(this.plugin.settings.perplexityModel).onChange(async s=>{this.plugin.settings.perplexityModel=s,await this.plugin.saveSettings()})),e.createEl("h4",{text:"Research-Mode-Specific Perplexity Parameters"}),e.createEl("p",{text:"Complete Perplexity API parameter set, optimized per research mode:",cls:"setting-item-description"}),this.addResearchModePerplexitySettings(e,"quickPerplexity","\u26A1 Quick Mode","Fast, focused responses with minimal context"),this.addResearchModePerplexitySettings(e,"comprehensivePerplexity","\u{1F50D} Comprehensive Mode","Balanced analysis with citations"),this.addResearchModePerplexitySettings(e,"deepPerplexity","\u{1F52C} Deep Mode","Thorough research with maximum context"),this.addResearchModePerplexitySettings(e,"reasoningPerplexity","\u{1F9E0} Reasoning Mode","Logical analysis with focused search")}addResearchModePerplexitySettings(e,t,s,i){let n=e.createEl("div",{cls:"research-mode-settings"});n.createEl("h5",{text:s,cls:"research-mode-title"}),n.createEl("p",{text:i,cls:"research-mode-description"});let a=t,r=this.plugin.settings[a];new l.Setting(n).setName("Temperature").setDesc("Controls randomness (0.0 = deterministic, 2.0 = very random)").addSlider(o=>o.setLimits(0,2,.1).setValue(r.temperature).setDynamicTooltip().onChange(async c=>{this.plugin.settings[a].temperature=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Max Tokens").setDesc("Maximum response length (100-4096)").addSlider(o=>o.setLimits(100,4096,100).setValue(r.max_tokens).setDynamicTooltip().onChange(async c=>{this.plugin.settings[a].max_tokens=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Top P").setDesc("Nucleus sampling threshold (0.1 = conservative, 1.0 = diverse)").addSlider(o=>o.setLimits(.1,1,.1).setValue(r.top_p).setDynamicTooltip().onChange(async c=>{this.plugin.settings[a].top_p=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Top K").setDesc("Number of top tokens to consider (1-100)").addSlider(o=>o.setLimits(1,100,1).setValue(r.top_k).setDynamicTooltip().onChange(async c=>{this.plugin.settings[a].top_k=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Frequency Penalty").setDesc("Reduces repetition based on frequency (-2.0 to 2.0)").addSlider(o=>o.setLimits(-2,2,.1).setValue(r.frequency_penalty).setDynamicTooltip().onChange(async c=>{this.plugin.settings[a].frequency_penalty=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Presence Penalty").setDesc("Encourages new topics (-2.0 to 2.0)").addSlider(o=>o.setLimits(-2,2,.1).setValue(r.presence_penalty).setDynamicTooltip().onChange(async c=>{this.plugin.settings[a].presence_penalty=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Search Recency Filter").setDesc("Filter search results by recency").addDropdown(o=>o.addOption("","No filter").addOption("hour","Past hour").addOption("day","Past day").addOption("week","Past week").addOption("month","Past month").setValue(r.search_recency_filter).onChange(async c=>{this.plugin.settings[a].search_recency_filter=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Search Context Size").setDesc("Number of search results to include in context (1-20)").addSlider(o=>o.setLimits(1,20,1).setValue(r.search_context_size).setDynamicTooltip().onChange(async c=>{this.plugin.settings[a].search_context_size=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Return Related Questions").setDesc("Include related questions in response").addToggle(o=>o.setValue(r.return_related_questions).onChange(async c=>{this.plugin.settings[a].return_related_questions=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Return Citations").setDesc("Include source citations in response").addToggle(o=>o.setValue(r.return_citations).onChange(async c=>{this.plugin.settings[a].return_citations=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Return Images").setDesc("Include relevant images in response").addToggle(o=>o.setValue(r.return_images).onChange(async c=>{this.plugin.settings[a].return_images=c,await this.plugin.saveSettings()})),new l.Setting(n).setName("Search Domain Filter").setDesc("Comma-separated list of domains to search (e.g., arxiv.org, wikipedia.org)").addTextArea(o=>o.setPlaceholder("arxiv.org, wikipedia.org, github.com").setValue(r.search_domain_filter.join(", ")).onChange(async c=>{let d=c.split(",").map(p=>p.trim()).filter(p=>p);this.plugin.settings[a].search_domain_filter=d,await this.plugin.saveSettings()}))}addTavilySettings(e){new l.Setting(e).setName("Tavily API Key").setDesc("Get your API key from Tavily.com (1000 free credits/month)").addText(t=>t.setPlaceholder("Enter your Tavily API key").setValue(this.plugin.settings.tavilyApiKey).onChange(async s=>{this.plugin.settings.tavilyApiKey=s,await this.plugin.saveSettings()}))}addExaSettings(e){e.hasClass("provider-tab-content")||new l.Setting(e).setName("\u{1F9E0} Exa API Key").setDesc("Get your API key from dashboard.exa.ai ($10 free credits to start)").addText(a=>a.setPlaceholder("Enter your Exa API key").setValue(this.plugin.settings.exaApiKey).onChange(async r=>{this.plugin.settings.exaApiKey=r,await this.plugin.saveSettings()})),e.createEl("h4",{text:"\u{1F3AF} Search Configuration"}),new l.Setting(e).setName("Search Type").setDesc("Choose search algorithm based on your needs").addDropdown(a=>{a.addOption("auto","\u{1F916} Auto - Intelligent blend of neural & keyword (recommended)"),a.addOption("neural","\u{1F9E0} Neural - Semantic understanding, finds conceptually similar content"),a.addOption("keyword","\u{1F524} Keyword - Traditional exact word matching, faster"),a.addOption("fast","\u26A1 Fast - Ultra-fast 425ms search, optimized for speed"),a.setValue(this.plugin.settings.exaSearchType),a.onChange(async r=>{this.plugin.settings.exaSearchType=r,await this.plugin.saveSettings()})});let t=e.createEl("div",{cls:"setting-help-text"});t.innerHTML=`
			<strong>Search Type Guide:</strong>
			<ul>
				<li><strong>Auto:</strong> Best of both worlds - combines neural semantic understanding with keyword precision</li>
				<li><strong>Neural:</strong> Understands meaning and context, finds related concepts even without exact keywords</li>
				<li><strong>Keyword:</strong> Traditional search, fast and precise for exact term matching</li>
				<li><strong>Fast:</strong> Lightning-fast results in 425ms, perfect for quick queries</li>
			</ul>
		`,new l.Setting(e).setName("Content Category Filter").setDesc("Focus search on specific content types for better relevance").addDropdown(a=>{a.addOption("","\u{1F310} All Categories - Search everywhere"),a.addOption("company","\u{1F3E2} Company - Corporate websites and business info"),a.addOption("research paper","\u{1F4DA} Research Papers - Academic and scientific papers"),a.addOption("news","\u{1F4F0} News - News articles and journalism"),a.addOption("pdf","\u{1F4C4} PDF Documents - Focus on PDF files"),a.addOption("github","\u{1F4BB} GitHub - Code repositories and developer content"),a.addOption("tweet","\u{1F426} Twitter - Social media posts and discussions"),a.addOption("personal site","\u{1F464} Personal Sites - Blogs and personal websites"),a.addOption("linkedin profile","\u{1F454} LinkedIn - Professional profiles and content"),a.addOption("financial report","\u{1F4B0} Financial Reports - Financial and investment data"),a.setValue(this.plugin.settings.exaCategory),a.onChange(async r=>{this.plugin.settings.exaCategory=r,await this.plugin.saveSettings()})}),e.createEl("h4",{text:"\u{1F4C4} Content Extraction"}),e.createEl("p",{text:"Extract rich content from web pages for comprehensive analysis",cls:"setting-section-description"}),new l.Setting(e).setName("\u{1F4DD} Extract Full Text").setDesc("Extract complete text content from web pages (slower but more comprehensive)").addToggle(a=>a.setValue(this.plugin.settings.exaGetText).onChange(async r=>{this.plugin.settings.exaGetText=r,await this.plugin.saveSettings()})),new l.Setting(e).setName("\u2728 Extract Highlights").setDesc("Get key highlights and important excerpts (faster, focuses on main points)").addToggle(a=>a.setValue(this.plugin.settings.exaGetHighlights).onChange(async r=>{this.plugin.settings.exaGetHighlights=r,await this.plugin.saveSettings()})),new l.Setting(e).setName("\u{1F4CB} Generate AI Summary").setDesc("Create AI-generated summaries of content (best for quick understanding)").addToggle(a=>a.setValue(this.plugin.settings.exaGetSummary).onChange(async r=>{this.plugin.settings.exaGetSummary=r,await this.plugin.saveSettings()}));let s=e.createEl("div",{cls:"setting-help-text"});s.innerHTML=`
			<strong>\u{1F4A1} Content Extraction Tips:</strong>
			<ul>
				<li><strong>Full Text:</strong> Best for detailed analysis, but slower and uses more tokens</li>
				<li><strong>Highlights:</strong> Perfect balance of speed and relevance</li>
				<li><strong>AI Summary:</strong> Fastest option, great for quick research</li>
				<li><strong>Recommendation:</strong> Enable Highlights + Summary for optimal results</li>
			</ul>
		`,e.createEl("h4",{text:"\u{1F50D} Advanced Filtering"}),e.createEl("p",{text:"Fine-tune your search with domain and content filters",cls:"setting-section-description"}),new l.Setting(e).setName("\u2705 Include Domains").setDesc("Only search within these domains (comma-separated). Examples: arxiv.org, github.com, wikipedia.org").addTextArea(a=>a.setPlaceholder("arxiv.org, github.com, scholar.google.com").setValue(this.plugin.settings.exaIncludeDomains.join(", ")).onChange(async r=>{this.plugin.settings.exaIncludeDomains=r.split(",").map(o=>o.trim()).filter(o=>o.length>0),await this.plugin.saveSettings()})),new l.Setting(e).setName("\u274C Exclude Domains").setDesc("Exclude these domains from search results. Examples: reddit.com, quora.com").addTextArea(a=>a.setPlaceholder("reddit.com, quora.com, pinterest.com").setValue(this.plugin.settings.exaExcludeDomains.join(", ")).onChange(async r=>{this.plugin.settings.exaExcludeDomains=r.split(",").map(o=>o.trim()).filter(o=>o.length>0),await this.plugin.saveSettings()})),e.createEl("h5",{text:"\u{1F4C5} Date Range Filtering"}),new l.Setting(e).setName("\u{1F4C5} Start Date").setDesc("Only include content published after this date (YYYY-MM-DD format)").addText(a=>a.setPlaceholder("2024-01-01").setValue(this.plugin.settings.exaStartDate).onChange(async r=>{this.plugin.settings.exaStartDate=r,await this.plugin.saveSettings()})),new l.Setting(e).setName("\u{1F4C5} End Date").setDesc("Only include content published before this date (YYYY-MM-DD format)").addText(a=>a.setPlaceholder("2024-12-31").setValue(this.plugin.settings.exaEndDate).onChange(async r=>{this.plugin.settings.exaEndDate=r,await this.plugin.saveSettings()})),e.createEl("h5",{text:"\u{1F524} Text Pattern Filtering"}),new l.Setting(e).setName("\u2705 Must Include Text").setDesc("Results must contain these phrases (comma-separated, max 5 words each)").addTextArea(a=>a.setPlaceholder("machine learning, artificial intelligence, research").setValue(this.plugin.settings.exaIncludeText.join(", ")).onChange(async r=>{this.plugin.settings.exaIncludeText=r.split(",").map(o=>o.trim()).filter(o=>o.length>0),await this.plugin.saveSettings()})),new l.Setting(e).setName("\u274C Must Exclude Text").setDesc("Results must NOT contain these phrases (comma-separated)").addTextArea(a=>a.setPlaceholder("advertisement, sponsored, click here").setValue(this.plugin.settings.exaExcludeText.join(", ")).onChange(async r=>{this.plugin.settings.exaExcludeText=r.split(",").map(o=>o.trim()).filter(o=>o.length>0),await this.plugin.saveSettings()}));let i=e.createEl("div",{cls:"exa-presets"});i.createEl("h5",{text:"\u{1F39B}\uFE0F Exa Quick Presets"});let n=i.createEl("div",{cls:"presets-grid"});new l.Setting(n).setName("\u{1F393} Academic Research").setDesc("Optimize for research papers and academic content").addButton(a=>a.setButtonText("Apply").onClick(async()=>{this.plugin.settings.exaSearchType="neural",this.plugin.settings.exaCategory="research paper",this.plugin.settings.exaIncludeDomains=["arxiv.org","scholar.google.com","pubmed.ncbi.nlm.nih.gov","ieee.org"],this.plugin.settings.exaGetText=!0,this.plugin.settings.exaGetHighlights=!0,this.plugin.settings.exaGetSummary=!0,await this.plugin.saveSettings(),this.display()})),new l.Setting(n).setName("\u{1F4F0} News & Current Events").setDesc("Focus on recent news and current information").addButton(a=>a.setButtonText("Apply").onClick(async()=>{this.plugin.settings.exaSearchType="fast",this.plugin.settings.exaCategory="news",this.plugin.settings.exaStartDate=new Date(Date.now()-30*24*60*60*1e3).toISOString().split("T")[0],this.plugin.settings.exaGetHighlights=!0,this.plugin.settings.exaGetSummary=!0,this.plugin.settings.exaGetText=!1,await this.plugin.saveSettings(),this.display()})),new l.Setting(n).setName("\u{1F4BB} Developer Resources").setDesc("Focus on code, documentation, and technical content").addButton(a=>a.setButtonText("Apply").onClick(async()=>{this.plugin.settings.exaSearchType="neural",this.plugin.settings.exaCategory="github",this.plugin.settings.exaIncludeDomains=["github.com","stackoverflow.com","developer.mozilla.org","docs.python.org"],this.plugin.settings.exaGetText=!0,this.plugin.settings.exaGetHighlights=!0,await this.plugin.saveSettings(),this.display()})),new l.Setting(n).setName("\u26A1 Speed Optimized").setDesc("Ultra-fast searches with minimal latency").addButton(a=>a.setButtonText("Apply").onClick(async()=>{this.plugin.settings.exaSearchType="fast",this.plugin.settings.exaGetText=!1,this.plugin.settings.exaGetHighlights=!0,this.plugin.settings.exaGetSummary=!1,this.plugin.settings.exaIncludeDomains=[],this.plugin.settings.exaExcludeDomains=[],await this.plugin.saveSettings(),this.display()}))}addCustomPromptSettings(e){let{contentEl:t}=this.createCollapsibleSection(e,"\u{1F3A8} Custom Research Mode Prompts","Advanced prompt engineering with professional frameworks","custom-prompts",!1),s=t.createEl("div",{cls:"setting-help-text"});s.innerHTML=`
			<strong>\u{1F9E0} Professional Prompt Frameworks:</strong>
			<ul>
				<li><strong>Quick Mode:</strong> Role-based + Constraints - Concise, accurate, avoid hallucination</li>
				<li><strong>Comprehensive:</strong> CRISPE Framework - Clarity, Relevance, Iteration, Specificity, Parameters, Examples</li>
				<li><strong>Deep Research:</strong> TRACE Framework - Task, Request, Action, Context, Example</li>
				<li><strong>Reasoning:</strong> Chain-of-Thought + Meta-prompting - Step-by-step logical analysis</li>
			</ul>
			<p><strong>\u{1F4A1} Use placeholder:</strong> <code>{query}</code> will be replaced with the actual question.</p>
		`,new l.Setting(t).setName("\u26A1 Quick Mode Prompt").setDesc("Framework: Role Assignment + Clear Constraints. Focus on concise, accurate answers (2-3 sentences)").addTextArea(i=>i.setPlaceholder("Enter custom prompt for quick mode...").setValue(this.plugin.settings.quickPrompt).onChange(async n=>{this.plugin.settings.quickPrompt=n,await this.plugin.saveSettings()})),new l.Setting(t).setName("\u{1F50D} Comprehensive Mode Prompt").setDesc("Framework: CRISPE (Clarity, Relevance, Iteration, Specificity, Parameters, Examples). Comprehensive analysis 400-600 words").addTextArea(i=>i.setPlaceholder("Enter custom prompt for comprehensive mode...").setValue(this.plugin.settings.comprehensivePrompt).onChange(async n=>{this.plugin.settings.comprehensivePrompt=n,await this.plugin.saveSettings()})),new l.Setting(t).setName("\u{1F3AF} Deep Research Mode Prompt").setDesc("Framework: TRACE (Task, Request, Action, Context, Example). Multi-dimensional deep research 800-1200 words").addTextArea(i=>i.setPlaceholder("Enter custom prompt for deep research mode...").setValue(this.plugin.settings.deepPrompt).onChange(async n=>{this.plugin.settings.deepPrompt=n,await this.plugin.saveSettings()})),new l.Setting(t).setName("\u{1F9E0} Reasoning Mode Prompt").setDesc("Framework: Chain-of-Thought + Meta-prompting. Step-by-step logical analysis with self-verification").addTextArea(i=>i.setPlaceholder("Enter custom prompt for reasoning mode...").setValue(this.plugin.settings.reasoningPrompt).onChange(async n=>{this.plugin.settings.reasoningPrompt=n,await this.plugin.saveSettings()})),this.createResetButton(t,"\u{1F504} Reset to Improved Professional Prompts","Restore enhanced prompts with professional frameworks",()=>{this.plugin.settings.quickPrompt=S.quickPrompt,this.plugin.settings.comprehensivePrompt=S.comprehensivePrompt,this.plugin.settings.deepPrompt=S.deepPrompt,this.plugin.settings.reasoningPrompt=S.reasoningPrompt})}updateProviderInfo(e,t){e.empty();let i={gemini:{name:"Google Gemini",description:"Direct Google Search integration with real-time grounding",features:["Real-time web search","Google Search results","Source citations","Multiple models"],pricing:"Free tier available",latency:"~2-3 seconds",hasKey:!!this.plugin.settings.geminiApiKey},perplexity:{name:"Perplexity AI",description:"Real-time web search with academic-quality citations",features:["Real-time search","Citation tracking","Multi-model support","Reasoning mode"],pricing:"$20/month for Pro",latency:"~1-2 seconds",hasKey:!!this.plugin.settings.perplexityApiKey},tavily:{name:"Tavily Search",description:"Advanced web search API optimized for AI applications",features:["Advanced search depth","AI-optimized results","Source ranking","Content filtering"],pricing:"1000 free credits/month",latency:"~1-2 seconds",hasKey:!!this.plugin.settings.tavilyApiKey},exa:{name:"Exa Neural Search",description:"Semantic neural search with 425ms lightning-fast latency",features:["Neural semantic search","425ms latency","Content extraction","Domain filtering"],pricing:"$10 free credits",latency:"~425ms (fastest)",hasKey:!!this.plugin.settings.exaApiKey}}[t];if(!i)return;let n=e.createEl("div",{cls:"provider-info-card"}),a=n.createEl("div",{cls:"provider-info-header"});a.createEl("h4",{text:i.name}),a.appendChild(this.createStatusIndicator(i.hasKey,i.name)),n.createEl("p",{text:i.description,cls:"provider-description"});let r=n.createEl("ul",{cls:"provider-features"});i.features.forEach(c=>{r.createEl("li",{text:c})});let o=n.createEl("div",{cls:"provider-specs"});o.createEl("span",{text:`\u{1F4B0} ${i.pricing}`,cls:"spec-item"}),o.createEl("span",{text:`\u26A1 ${i.latency}`,cls:"spec-item"})}addAllApiKeys(e){let t=new l.Setting(e).setName("\u{1F916} Google Gemini API Key").setDesc("Get from Google AI Studio (aistudio.google.com) - Free tier with generous limits");t.settingEl.appendChild(this.createStatusIndicator(!!this.plugin.settings.geminiApiKey,"Gemini")),t.addText(a=>a.setPlaceholder("Enter your Gemini API key").setValue(this.plugin.settings.geminiApiKey).onChange(async r=>{this.plugin.settings.geminiApiKey=r,await this.plugin.saveSettings(),this.display()}));let s=new l.Setting(e).setName("\u{1F50D} Perplexity AI API Key").setDesc("Get from Perplexity.ai - $20/month Pro plan for full access");s.settingEl.appendChild(this.createStatusIndicator(!!this.plugin.settings.perplexityApiKey,"Perplexity")),s.addText(a=>a.setPlaceholder("Enter your Perplexity API key").setValue(this.plugin.settings.perplexityApiKey).onChange(async r=>{this.plugin.settings.perplexityApiKey=r,await this.plugin.saveSettings(),this.display()}));let i=new l.Setting(e).setName("\u{1F310} Tavily Search API Key").setDesc("Get from Tavily.com - 1000 free credits monthly, then $50/month");i.settingEl.appendChild(this.createStatusIndicator(!!this.plugin.settings.tavilyApiKey,"Tavily")),i.addText(a=>a.setPlaceholder("Enter your Tavily API key").setValue(this.plugin.settings.tavilyApiKey).onChange(async r=>{this.plugin.settings.tavilyApiKey=r,await this.plugin.saveSettings(),this.display()}));let n=new l.Setting(e).setName("\u{1F9E0} Exa Neural Search API Key").setDesc("Get from dashboard.exa.ai - $10 free credits, then usage-based pricing");n.settingEl.appendChild(this.createStatusIndicator(!!this.plugin.settings.exaApiKey,"Exa")),n.addText(a=>a.setPlaceholder("Enter your Exa API key").setValue(this.plugin.settings.exaApiKey).onChange(async r=>{this.plugin.settings.exaApiKey=r,await this.plugin.saveSettings(),this.display()}))}addProviderSpecificSettings(e){let{contentEl:t}=this.createCollapsibleSection(e,`\u2699\uFE0F ${this.plugin.settings.provider.charAt(0).toUpperCase()+this.plugin.settings.provider.slice(1)} Settings`,`Advanced configuration for ${this.plugin.settings.provider}`,"provider-specific",!1);switch(this.plugin.settings.provider){case"gemini":this.addGeminiSettings(t);break;case"perplexity":this.addPerplexitySettings(t);break;case"tavily":this.addTavilySettings(t);break;case"exa":this.addExaSettings(t);break}}addAdvancedProviderSettings(e){let{contentEl:t}=this.createCollapsibleSection(e,"\u{1F527} Advanced Provider Configurations","Fine-tune settings for all providers (for power users)","advanced-providers",!1),s=t.createEl("div",{cls:"provider-tabs"}),i=t.createEl("div",{cls:"provider-tabs-content"});["gemini","perplexity","tavily","exa"].forEach((a,r)=>{let o=s.createEl("button",{cls:`provider-tab ${r===0?"active":""}`,text:a.charAt(0).toUpperCase()+a.slice(1),attr:{"data-provider":a}}),c=i.createEl("div",{cls:`provider-tab-content ${r===0?"active":""}`,attr:{"data-provider":a}});switch(a){case"gemini":this.addGeminiAdvancedSettings(c);break;case"perplexity":this.addPerplexityAdvancedSettings(c);break;case"tavily":this.addTavilyAdvancedSettings(c);break;case"exa":this.addExaAdvancedSettings(c);break}o.addEventListener("click",()=>{s.querySelectorAll(".provider-tab").forEach(d=>d.removeClass("active")),i.querySelectorAll(".provider-tab-content").forEach(d=>d.removeClass("active")),o.addClass("active"),c.addClass("active")})})}addPresetConfigurations(e){let{contentEl:t}=this.createCollapsibleSection(e,"\u{1F39B}\uFE0F Preset Configurations","Quick presets for different use cases","presets",!1),s=t.createEl("div",{cls:"preset-buttons"});new l.Setting(t).setName("\u26A1 Speed Optimized").setDesc("Optimize for fastest responses (Exa fast search, minimal results)").addButton(i=>i.setButtonText("Apply Speed Preset").onClick(async()=>{this.plugin.settings.provider="exa",this.plugin.settings.exaSearchType="fast",this.plugin.settings.maxResults=3,this.plugin.settings.exaGetText=!1,this.plugin.settings.exaGetHighlights=!0,this.plugin.settings.exaGetSummary=!1,await this.plugin.saveSettings(),this.display()})),new l.Setting(t).setName("\u{1F50D} Comprehensive Research").setDesc("Optimize for thorough research (Multiple sources, full content)").addButton(i=>i.setButtonText("Apply Research Preset").onClick(async()=>{this.plugin.settings.maxResults=10,this.plugin.settings.exaSearchType="neural",this.plugin.settings.exaGetText=!0,this.plugin.settings.exaGetHighlights=!0,this.plugin.settings.exaGetSummary=!0,await this.plugin.saveSettings(),this.display()})),new l.Setting(t).setName("\u{1F393} Academic Focus").setDesc("Optimize for academic and research sources").addButton(i=>i.setButtonText("Apply Academic Preset").onClick(async()=>{this.plugin.settings.provider="exa",this.plugin.settings.exaSearchType="neural",this.plugin.settings.exaCategory="research paper",this.plugin.settings.exaIncludeDomains=["arxiv.org","scholar.google.com","pubmed.ncbi.nlm.nih.gov"],this.plugin.settings.maxResults=8,await this.plugin.saveSettings(),this.display()})),this.createResetButton(t,"\u{1F504} Reset All Settings","Reset all settings to default values",()=>{Object.assign(this.plugin.settings,S)})}addChatSavingSettings(e){let{contentEl:t}=this.createCollapsibleSection(e,"\u{1F4BE} Chat Saving","Save chat conversations as notes in your vault","chat-saving",!1);new l.Setting(t).setName("Enable Chat Saving").setDesc("Allow saving chat conversations to your vault").addToggle(s=>s.setValue(this.plugin.settings.chatSaveEnabled).onChange(async i=>{this.plugin.settings.chatSaveEnabled=i,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.chatSaveEnabled&&(new l.Setting(t).setName("Chat Folder Name").setDesc("Folder where chat conversations will be saved").addText(s=>s.setPlaceholder("AI Web Search Chats").setValue(this.plugin.settings.chatFolderName).onChange(async i=>{this.plugin.settings.chatFolderName=i||"AI Web Search Chats",await this.plugin.saveSettings()})),new l.Setting(t).setName("Note Naming Template").setDesc("How to name saved chat notes").addDropdown(s=>s.addOption("timestamp-query","Timestamp + Query (2024-01-15-12-30-how-to-cook)").addOption("query-timestamp","Query + Timestamp (how-to-cook-2024-01-15-12-30)").addOption("query-only","Query Only (how-to-cook)").addOption("counter","Counter Only (chat-1, chat-2, ...)").setValue(this.plugin.settings.chatNoteTemplate).onChange(async i=>{this.plugin.settings.chatNoteTemplate=i,await this.plugin.saveSettings()})),t.createEl("div",{cls:"settings-help-text",text:'\u{1F4A1} Use the "Send & Save" button in the chat interface to save conversations. Saved notes will include metadata, timestamps, and full conversation history.'}))}addGeminiAdvancedSettings(e){e.createEl("h5",{text:"Gemini Advanced Parameters"}),e.createEl("p",{text:"Fine-tune Gemini model behavior. These affect creativity, randomness, and response quality.",cls:"settings-help-text"})}addPerplexityAdvancedSettings(e){e.createEl("h5",{text:"Perplexity Advanced Parameters"}),e.createEl("p",{text:"Control Perplexity search depth and response characteristics.",cls:"settings-help-text"})}addTavilyAdvancedSettings(e){e.createEl("h5",{text:"Tavily Advanced Parameters"}),e.createEl("p",{text:"Tavily uses intelligent defaults. Additional customization options may be added in future updates.",cls:"settings-help-text"})}addExaAdvancedSettings(e){e.createEl("h5",{text:"Exa Neural Search Advanced Parameters"}),e.createEl("p",{text:"Exa offers the most customization options for semantic search and content filtering.",cls:"settings-help-text"}),this.addExaSettings(e)}};
